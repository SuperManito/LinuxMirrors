#!/bin/bash
## Author: SuperManito
## Modified: 2023-05-02
## License: MIT
## Github: https://github.com/SuperManito/LinuxMirrors
 [0;1;35;95mâ¡‡[0m  [0;1;33;93mâ „[0m [0;1;32;92mâ£€â¡€[0m [0;1;36;96mâ¡€[0;1;34;94mâ¢€[0m [0;1;35;95mâ¡€â¢€[0m [0;1;31;91mâ¡·[0;1;33;93mâ¢¾[0m [0;1;32;92mâ „[0m [0;1;36;96mâ¡€â£€[0m [0;1;34;94mâ¡€[0;1;35;95mâ£€[0m [0;1;31;91mâ¢€â¡€[0m [0;1;33;93mâ¡€[0;1;32;92mâ£€[0m [0;1;36;96mâ¢€â£€[0m
 [0;1;31;91mâ §[0;1;33;93mâ ¤[0m [0;1;32;92mâ ‡[0m [0;1;36;96mâ ‡â ¸[0m [0;1;34;94mâ £[0;1;35;95mâ ¼[0m [0;1;31;91mâ œâ £[0m [0;1;33;93mâ ‡[0;1;32;92mâ ¸[0m [0;1;36;96mâ ‡[0m [0;1;34;94mâ [0m  [0;1;35;95mâ [0m  [0;1;33;93mâ £â œ[0m [0;1;32;92mâ [0m  [0;1;34;94mâ ­â •[0m
function AuthorSignature() {
    echo -e "\n$COMPLETE è„šæœ¬æ‰§è¡Œç»“æŸ\n"
    echo -e '\033[0;1;35;95mâ”Œâ”€\033[0;1;31;91mâ”€â”€\033[0;1;33;93mâ”€â”€\033[0;1;32;92mâ”€â”€\033[0;1;36;96mâ”€â”€\033[0;1;34;94mâ”€â”€\033[0;1;35;95mâ”€â”€\033[0;1;31;91mâ”€â”€\033[0;1;33;93mâ”€â”€\033[0;1;32;92mâ”€â”€\033[0;1;36;96mâ”€â”€\033[0;1;34;94mâ”€â”€\033[0;1;35;95mâ”€â”€\033[0;1;31;91mâ”€â”€\033[0;1;33;93mâ”€â”€\033[0;1;32;92mâ”€â”€\033[0;1;36;96mâ”€â”€\033[0;1;34;94mâ”€â”€\033[0;1;35;95mâ”€â”€\033[0;1;31;91mâ”€â”€\033[0;1;33;93mâ”€â”€\033[0;1;32;92mâ”€â”€\033[0;1;36;96mâ”€â”€\033[0;1;34;94mâ”€â”€\033[0;1;35;95mâ”€â”€\033[0;1;31;91mâ”€â”€\033[0;1;33;93mâ”€â”€\033[0;1;32;92mâ”€â”€\033[0;1;36;96mâ”€â”€\033[0;1;34;94mâ”€â”€\033[0;1;35;95mâ”€â”\033[0m'
    echo -e '\033[0;1;31;91mâ”‚\033[0m   \033[0;1;32;92m__\033[0;1;36;96m__\033[0;1;34;94m_\033[0m                       \033[0;1;34;94m__\033[0m  \033[0;1;31;91m__\033[0;1;33;93m_\033[0m            \033[0;1;33;93m_\033[0m \033[0;1;32;92m_\033[0;1;36;96m_\033[0m      \033[0;1;31;91mâ”‚\033[0m'
    echo -e '\033[0;1;33;93mâ”‚\033[0m  \033[0;1;32;92m/\033[0m \033[0;1;36;96m_\033[0;1;34;94m__\033[0;1;35;95m/_\033[0;1;31;91m_\033[0m  \033[0;1;33;93m_\033[0;1;32;92m__\033[0;1;36;96m__\033[0;1;34;94m_\033[0m  \033[0;1;35;95m_\033[0;1;31;91m__\033[0m  \033[0;1;32;92m__\033[0;1;36;96m__\033[0;1;34;94m_/\033[0m  \033[0;1;31;91m|/\033[0m  \033[0;1;32;92m/_\033[0;1;36;96m__\033[0m \033[0;1;34;94m_\033[0;1;35;95m__\033[0;1;31;91m__\033[0m  \033[0;1;32;92m(_\033[0;1;36;96m)\033[0m \033[0;1;34;94m/_\033[0;1;35;95m__\033[0;1;31;91m__\033[0m \033[0;1;33;93mâ”‚\033[0m'
    echo -e '\033[0;1;32;92mâ”‚\033[0m  \033[0;1;36;96m\\\033[0;1;34;94m__\033[0m \033[0;1;35;95m\\\033[0;1;31;91m/\033[0m \033[0;1;33;93m/\033[0m \033[0;1;32;92m/\033[0m \033[0;1;36;96m/\033[0m \033[0;1;34;94m__\033[0m \033[0;1;35;95m\\\033[0;1;31;91m/\033[0m \033[0;1;33;93m_\033[0m \033[0;1;32;92m\/\033[0m \033[0;1;36;96m_\033[0;1;34;94m__\033[0;1;35;95m/\033[0m \033[0;1;31;91m/|\033[0;1;33;93m_/\033[0m \033[0;1;32;92m/\033[0m \033[0;1;36;96m_\033[0;1;34;94m_\033[0m \033[0;1;35;95m`/\033[0m \033[0;1;31;91m_\033[0;1;33;93m_\033[0m \033[0;1;32;92m\/\033[0m \033[0;1;36;96m/\033[0m \033[0;1;34;94m_\033[0;1;35;95m_/\033[0m \033[0;1;31;91m_\033[0;1;33;93m_\033[0m \033[0;1;32;92m\â”‚\033[0m'
    echo -e '\033[0;1;36;96mâ”‚\033[0m \033[0;1;34;94m__\033[0;1;35;95m_/\033[0m \033[0;1;31;91m/\033[0m \033[0;1;33;93m/\033[0;1;32;92m_/\033[0m \033[0;1;36;96m/\033[0m \033[0;1;34;94m/\033[0;1;35;95m_/\033[0m \033[0;1;31;91m/\033[0m  \033[0;1;32;92m__\033[0;1;36;96m/\033[0m \033[0;1;34;94m/\033[0m  \033[0;1;35;95m/\033[0m \033[0;1;31;91m/\033[0m  \033[0;1;32;92m/\033[0m \033[0;1;36;96m/\033[0m \033[0;1;34;94m/_\033[0;1;35;95m/\033[0m \033[0;1;31;91m/\033[0m \033[0;1;33;93m/\033[0m \033[0;1;32;92m/\033[0m \033[0;1;36;96m/\033[0m \033[0;1;34;94m/\033[0m \033[0;1;35;95m/_\033[0;1;31;91m/\033[0m \033[0;1;33;93m/_\033[0;1;32;92m/\033[0m \033[0;1;36;96m/â”‚\033[0m'
    echo -e '\033[0;1;34;94mâ”‚/\033[0;1;35;95m__\033[0;1;31;91m__\033[0;1;33;93m/\\\033[0;1;32;92m__\033[0;1;36;96m,_\033[0;1;34;94m/\033[0m \033[0;1;35;95m._\033[0;1;31;91m__\033[0;1;33;93m/\\\033[0;1;32;92m__\033[0;1;36;96m_/\033[0;1;34;94m_/\033[0m  \033[0;1;31;91m/_\033[0;1;33;93m/\033[0m  \033[0;1;32;92m/\033[0;1;36;96m_/\033[0;1;34;94m\_\033[0;1;35;95m_,\033[0;1;31;91m_/\033[0;1;33;93m_/\033[0m \033[0;1;32;92m/\033[0;1;36;96m_/\033[0;1;34;94m_/\033[0;1;35;95m\_\033[0;1;31;91m_/\033[0;1;33;93m\_\033[0;1;32;92m__\033[0;1;36;96m_/\033[0m \033[0;1;34;94mâ”‚\033[0m'
    echo -e '\033[0;1;35;95mâ”‚\033[0m          \033[0;1;34;94m/\033[0;1;35;95m_/\033[0m                                               \033[0;1;35;95mâ”‚\033[0m'
    echo -e '\033[0;1;31;91mâ””â”€\033[0;1;33;93mâ”€â”€\033[0;1;32;92mâ”€â”€\033[0;1;36;96mâ”€â”€\033[0;1;34;94mâ”€â”€\033[0;1;35;95mâ”€â”€\033[0;1;31;91mâ”€â”€\033[0;1;33;93mâ”€â”€\033[0;1;32;92mâ”€â”€\033[0;1;36;96mâ”€â”€\033[0;1;34;94mâ”€â”€\033[0;1;35;95mâ”€â”€\033[0;1;31;91mâ”€â”€\033[0;1;33;93mâ”€â”€\033[0;1;32;92mâ”€â”€\033[0;1;36;96mâ”€â”€\033[0;1;34;94mâ”€â”€\033[0;1;35;95mâ”€â”€\033[0;1;31;91mâ”€â”€\033[0;1;33;93mâ”€â”€\033[0;1;32;92mâ”€â”€\033[0;1;36;96mâ”€â”€\033[0;1;34;94mâ”€â”€\033[0;1;35;95mâ”€â”€\033[0;1;31;91mâ”€â”€\033[0;1;33;93mâ”€â”€\033[0;1;32;92mâ”€â”€\033[0;1;36;96mâ”€â”€\033[0;1;34;94mâ”€â”€\033[0;1;35;95mâ”€â”€\033[0;1;31;91mâ”€â”˜\033[0m\n'

    echo -e " \033[1;34må®˜æ–¹ç½‘ç«™\033[0m https://supermanito.github.io/LinuxMirrors\n"
}

## å®šä¹‰ç³»ç»Ÿåˆ¤å®šå˜é‡
SYSTEM_DEBIAN="Debian"
SYSTEM_UBUNTU="Ubuntu"
SYSTEM_KALI="Kali"
SYSTEM_REDHAT="RedHat"
SYSTEM_RHEL="RedHat"
SYSTEM_CENTOS="CentOS"
SYSTEM_CENTOS_STREAM="CentOS Stream"
SYSTEM_ROCKY="Rocky"
SYSTEM_FEDORA="Fedora"
SYSTEM_OPENEULER="openEuler"

## å®šä¹‰ç›®å½•å’Œæ–‡ä»¶
File_LinuxRelease=/etc/os-release
File_RedHatRelease=/etc/redhat-release
File_openEulerRelease=/etc/openEuler-release
File_DebianVersion=/etc/debian_version
File_DebianSourceList=/etc/apt/sources.list
Dir_DebianExtendSource=/etc/apt/sources.list.d
Dir_RedHatRepos=/etc/yum.repos.d
Dir_openEulerRepos=/etc/yum.repos.d
Dir_openSUSERepos=/etc/zypp/repos.d

## å®šä¹‰ Docker ç›¸å…³å˜é‡
DockerDir=/etc/docker
DockerConfig=$DockerDir/daemon.json
DockerConfigBackup=$DockerDir/daemon.json.bak
DockerVersionFile=docker-version.txt
DockerCEVersionFile=docker-ce-version.txt
DockerCECLIVersionFile=docker-ce-cli-version.txt

## å®šä¹‰é¢œè‰²å˜é‡
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
PLAIN='\033[0m'
BOLD='\033[1m'
SUCCESS='[\033[32mOK\033[0m]'
COMPLETE='[\033[32mDONE\033[0m]'
WARN='[\033[33mWARN\033[0m]'
ERROR='[\033[31mERROR\033[0m]'
WORKING='[\033[34m*\033[0m]'

## ç³»ç»Ÿåˆ¤å®šå˜é‡
function EnvJudgment() {
    ## å®šä¹‰ç³»ç»Ÿåç§°
    SYSTEM_NAME="$(cat $File_LinuxRelease | grep -E "^NAME=" | awk -F '=' '{print$2}' | sed "s/[\'\"]//g")"
    cat $File_LinuxRelease | grep "PRETTY_NAME=" -q
    [ $? -eq 0 ] && SYSTEM_PRETTY_NAME="$(cat $File_LinuxRelease | grep -E "^PRETTY_NAME=" | awk -F '=' '{print$2}' | sed "s/[\'\"]//g")"
    ## å®šä¹‰ç³»ç»Ÿç‰ˆæœ¬å·
    SYSTEM_VERSION_NUMBER="$(cat $File_LinuxRelease | grep -E "^VERSION_ID=" | awk -F '=' '{print$2}' | sed "s/[\'\"]//g")"
    ## å®šä¹‰ç³»ç»ŸID
    SYSTEM_ID="$(cat $File_LinuxRelease | grep -E "^ID=" | awk -F '=' '{print$2}' | sed "s/[\'\"]//g")"
    ## åˆ¤å®šå½“å‰ç³»ç»Ÿæ´¾ç³»ï¼ˆDebian/RedHat/openEulerï¼‰
    if [ -s $File_RedHatRelease ]; then
        SYSTEM_FACTIONS="${SYSTEM_REDHAT}"
    elif [ -s $File_DebianVersion ]; then
        SYSTEM_FACTIONS="${SYSTEM_DEBIAN}"
    elif [ -s $File_openEulerRelease ]; then
        SYSTEM_FACTIONS="${SYSTEM_OPENEULER}"
    else
        echo -e "\n$ERROR æ— æ³•åˆ¤æ–­å½“å‰è¿è¡Œç¯å¢ƒï¼Œè¯·å…ˆç¡®è®¤æœ¬è„šæœ¬é’ˆå¯¹å½“å‰æ“ä½œç³»ç»Ÿæ˜¯å¦é€‚é…ï¼\n"
        exit
    fi
    ## åˆ¤å®šç³»ç»Ÿåç§°ã€ç‰ˆæœ¬ã€ç‰ˆæœ¬å·
    case "${SYSTEM_FACTIONS}" in
    "${SYSTEM_DEBIAN}")
        SYSTEM_JUDGMENT=$(lsb_release -is)
        SYSTEM_VERSION=$(lsb_release -cs)
        ;;
    "${SYSTEM_REDHAT}")
        SYSTEM_JUDGMENT="$(cat $File_RedHatRelease | awk -F ' ' '{printf$1}')"
        cat $File_RedHatRelease | grep -q "${SYSTEM_CENTOS_STREAM}"
        [ $? -eq 0 ] && SYSTEM_JUDGMENT="${SYSTEM_CENTOS_STREAM}"
        ;;
    "${SYSTEM_OPENEULER}")
        SYSTEM_JUDGMENT="${SYSTEM_OPENEULER}"
        ;;
    esac
    ## åˆ¤å®šç³»ç»Ÿå¤„ç†å™¨æ¶æ„
    case $(uname -m) in
    x86_64)
        SYSTEM_ARCH="x86_64"
        SOURCE_ARCH="amd64"
        ;;
    aarch64)
        SYSTEM_ARCH="ARM64"
        SOURCE_ARCH="arm64"
        ;;
    armv7l)
        SYSTEM_ARCH="ARMv7"
        SOURCE_ARCH="armhf"
        ;;
    armv6l)
        SYSTEM_ARCH="ARMv6"
        SOURCE_ARCH="armhf"
        ;;
    i386 | i686)
        SYSTEM_ARCH="x86_32"
        echo -e "\n${RED}---------- Docker Engine ä¸æ”¯æŒå®‰è£…åœ¨ x86_32 æ¶æ„çš„ç¯å¢ƒä¸Šï¼ ----------${PLAIN}\n"
        exit
        ;;
    *)
        SYSTEM_ARCH=$(uname -m)
        SOURCE_ARCH=armhf
        ;;
    esac
    ## å®šä¹‰è½¯ä»¶æºåˆ†æ”¯åç§°
    case "${SYSTEM_JUDGMENT}" in
    "${SYSTEM_RHEL}" | "${SYSTEM_CENTOS_STREAM}" | "${SYSTEM_ROCKY}" | "${SYSTEM_OPENEULER}")
        SOURCE_BRANCH="centos"
        ;;
    *)
        SOURCE_BRANCH="$(echo "${SYSTEM_JUDGMENT,,}" | sed "s/ /-/g")"
        ;;
    esac
    ## å®šä¹‰è½¯ä»¶æºåŒæ­¥/æ›´æ–°æ–‡å­—
    case "${SYSTEM_FACTIONS}" in
    "${SYSTEM_DEBIAN}")
        SYNC_TXT="æ›´æ–°"
        ;;
    "${SYSTEM_REDHAT}" | "${SYSTEM_OPENEULER}")
        SYNC_TXT="åŒæ­¥"
        ;;
    esac
}

## åŸºç¡€ç¯å¢ƒåˆ¤æ–­
function PermissionJudgment() {
    if [ $UID -ne 0 ]; then
        echo -e "\n$ERROR æƒé™ä¸è¶³ï¼Œè¯·ä½¿ç”¨ Root ç”¨æˆ·è¿è¡Œæœ¬è„šæœ¬\n"
        exit 1
    fi
}

## å…³é—­é˜²ç«å¢™å’ŒSELinux
function CloseFirewall() {
    local SelinuxConf=/etc/selinux/config
    if [ -x /usr/bin/systemctl ]; then
        if [[ $(systemctl is-active firewalld) == "active" ]]; then
            local CHOICE=$(echo -e "\n${BOLD}â””â”€ æ˜¯å¦å…³é—­é˜²ç«å¢™å’Œ SELinux ? [Y/n] ${PLAIN}")
            read -p "${CHOICE}" INPUT
            [ -z ${INPUT} ] && INPUT=Y
            case $INPUT in
            [Yy] | [Yy][Ee][Ss])
                systemctl disable --now firewalld >/dev/null 2>&1
                [ -s $SelinuxConf ] && sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" $SelinuxConfig && setenforce 0 >/dev/null 2>&1
                ;;
            [Nn] | [Nn][Oo]) ;;
            *)
                echo -e "\n$WARN è¾“å…¥é”™è¯¯ï¼Œé»˜è®¤ä¸å…³é—­ï¼"
                ;;
            esac
        fi
    fi
}

## å®‰è£…ç¯å¢ƒåŒ…
function InstallationEnvironment() {
    ## åˆ é™¤åŸæœ‰æº
    case "${SYSTEM_FACTIONS}" in
    "${SYSTEM_DEBIAN}")
        sed -i '/docker-ce/d' $File_DebianSourceList
        rm -rf $Dir_DebianExtendSource/docker.list
        ;;
    "${SYSTEM_REDHAT}")
        rm -rf $Dir_RedHatRepos/*docker*.repo
        ;;
    "${SYSTEM_OPENEULER}")
        rm -rf $Dir_openEulerRepos/*docker*.repo
        ;;
    esac
    echo -e "$WORKING å¼€å§‹${SYNC_TXT}è½¯ä»¶æº...\n"
    case "${SYSTEM_FACTIONS}" in
    "${SYSTEM_DEBIAN}")
        apt-get update
        ;;
    "${SYSTEM_REDHAT}" | "${SYSTEM_OPENEULER}")
        yum makecache
        ;;
    esac
    VERIFICATION_SOURCESYNC=$?
    if [ ${VERIFICATION_SOURCESYNC} -ne 0 ]; then
        echo -e "\n$ERROR è½¯ä»¶æº${SYNC_TXT}å‡ºé”™ï¼Œè¯·å…ˆç¡®ä¿è½¯ä»¶åŒ…ç®¡ç†å·¥å…·å¯ç”¨ï¼\n"
        exit
    fi
    echo -e "\n$COMPLETE è½¯ä»¶æº${SYNC_TXT}ç»“æŸ\n"
    case "${SYSTEM_FACTIONS}" in
    "${SYSTEM_DEBIAN}")
        apt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common
        ;;
    "${SYSTEM_REDHAT}")
        yum install -y yum-utils device-mapper-persistent-data lvm2
        ;;
    "${SYSTEM_OPENEULER}")
        dnf install -y dnf-utils device-mapper-persistent-data lvm2
        ;;
    esac

}

## å¸è½½æ—§ç‰ˆæœ¬çš„ Docker Engine
function RemoveOldVersion() {
    systemctl disable --now docker >/dev/null 2>&1
    sleep 2s
    case "${SYSTEM_FACTIONS}" in
    "${SYSTEM_DEBIAN}")
        apt-get remove -y docker-ce docker-ce-cli containerd.io runc >/dev/null 2>&1
        apt-get autoremove -y >/dev/null 2>&1
        ;;
    "${SYSTEM_REDHAT}" | "${SYSTEM_OPENEULER}")
        yum remove -y docker-ce docker-ce-cli containerd.io podman* runc >/dev/null 2>&1
        yum autoremove -y >/dev/null 2>&1
        ;;
    esac
}

## é…ç½® Docker CE æº
function ConfigureDockerCEMirror() {
    case "${SYSTEM_FACTIONS}" in
    "${SYSTEM_DEBIAN}")
        if [ "${SYSTEM_JUDGMENT}" = ${SYSTEM_KALI} ]; then
            curl -fsSL https://${SOURCE}/linux/debian/gpg | apt-key add - >/dev/null 2>&1
        else
            curl -fsSL https://${SOURCE}/linux/${SOURCE_BRANCH}/gpg | apt-key add - >/dev/null 2>&1
        fi
        echo "deb [arch=${SOURCE_ARCH}] https://${SOURCE}/linux/${SOURCE_BRANCH} ${SYSTEM_VERSION} stable" | tee $Dir_DebianExtendSource/docker.list >/dev/null 2>&1
        if [ "${SYSTEM_JUDGMENT}" = ${SYSTEM_KALI} ]; then
            sed -i "s/${SYSTEM_VERSION}/buster/g" $Dir_DebianExtendSource/docker.list
            sed -i "s/${SOURCE_BRANCH}/debian/g" $Dir_DebianExtendSource/docker.list
        fi
        apt-get update
        ;;
    "${SYSTEM_REDHAT}" | "${SYSTEM_OPENEULER}")
        yum-config-manager -y --add-repo https://${SOURCE}/linux/${SOURCE_BRANCH}/docker-ce.repo
        yum makecache
        sed -i "s|download.docker.com|${SOURCE}|g" $Dir_RedHatRepos/docker-ce.repo
        ;;
    esac
    [[ "${SYSTEM_FACTIONS}" == "${SYSTEM_OPENEULER}" ]] && sed -i "s|\$releasever|9|g" $Dir_RedHatRepos/docker-ce.repo
}

## å®‰è£… Docker Engine
function DockerEngine() {

    ## å¯¼å‡ºå¯å®‰è£…çš„ç‰ˆæœ¬åˆ—è¡¨
    function Export_VersionList() {
        case "${SYSTEM_FACTIONS}" in
        "${SYSTEM_DEBIAN}")
            apt-cache madison docker-ce | awk '{print $3}' | grep -Eo "[0-9][0-9].[0-9]{1,2}.[0-9]{1,2}" >$DockerCEVersionFile
            apt-cache madison docker-ce-cli | awk '{print $3}' | grep -Eo "[0-9][0-9].[0-9]{1,2}.[0-9]{1,2}" >$DockerCECLIVersionFile
            grep -wf $DockerCEVersionFile $DockerCECLIVersionFile >$DockerVersionFile
            ;;
        "${SYSTEM_REDHAT}" | "${SYSTEM_OPENEULER}")
            yum list docker-ce --showduplicates | sort -r | awk '{print $2}' | grep -Eo "[0-9][0-9].[0-9]{1,2}.[0-9]{1,2}" >$DockerCEVersionFile
            yum list docker-ce-cli --showduplicates | sort -r | awk '{print $2}' | grep -Eo "[0-9][0-9].[0-9]{1,2}.[0-9]{1,2}" >$DockerCECLIVersionFile
            grep -wf $DockerCEVersionFile $DockerCECLIVersionFile >$DockerVersionFile
            ;;
        esac
        rm -rf $DockerCEVersionFile $DockerCECLIVersionFile
    }

    ## å®‰è£…
    function Install() {
        if [[ ${DOCKER_VERSION_INSTALL_LATEST} == "True" ]]; then
            case "${SYSTEM_FACTIONS}" in
            "${SYSTEM_DEBIAN}")
                apt-get install -y docker-ce docker-ce-cli containerd.io
                ;;
            "${SYSTEM_REDHAT}" | "${SYSTEM_OPENEULER}")
                yum install -y docker-ce docker-ce-cli containerd.io
                ;;
            esac
        else
            Export_VersionList
            echo -e "\n${GREEN} --------- è¯·é€‰æ‹©ä½ è¦å®‰è£…çš„ç‰ˆæœ¬ï¼Œå¦‚ï¼š19.03.15 ---------- ${PLAIN}\n"
            cat $DockerVersionFile
            echo -e '\næ³¨ï¼šä»¥ä¸Šå¯ä¾›é€‰æ‹©çš„å®‰è£…ç‰ˆæœ¬ç”±å®˜æ–¹æºæä¾›ï¼Œè‹¥ç³»ç»Ÿè¿‡æ–°å¯èƒ½æ— æ³•å®‰è£…è¾ƒæ—§çš„ç‰ˆæœ¬'
            while true; do
                local CHOICE=$(echo -e "\n${BOLD}â””â”€ è¯·æ ¹æ®ä¸Šé¢çš„åˆ—è¡¨ï¼Œé€‰æ‹©å¹¶è¾“å…¥ä½ æƒ³è¦å®‰è£…çš„å…·ä½“ç‰ˆæœ¬å·ï¼š${PLAIN}\n")
                read -p "${CHOICE}" DOCKER_VERSION
                echo ''
                cat $DockerVersionFile | grep -Ew "${DOCKER_VERSION}" >/dev/null 2>&1
                if [ $? -eq 0 ]; then
                    echo ${DOCKER_VERSION} | grep -Ew '[1,2][0-9].[0,1]{1,2}.[0-9]{1,2}' >/dev/null 2>&1
                    if [ $? -eq 0 ]; then
                        rm -rf $DockerVersionFile
                        break
                    else
                        echo -e "$ERROR è¯·è¾“å…¥æ­£ç¡®çš„ç‰ˆæœ¬å·ï¼"
                    fi
                else
                    echo -e "$ERROR è¾“å…¥é”™è¯¯è¯·é‡æ–°è¾“å…¥ï¼"
                fi
            done
            case "${SYSTEM_FACTIONS}" in
            "${SYSTEM_DEBIAN}")
                CheckVersion=$(echo ${DOCKER_VERSION} | cut -c1-2)
                CheckSubversion=$(echo ${DOCKER_VERSION} | cut -c4-5)
                case ${CheckVersion} in
                18)
                    if [ ${CheckSubversion} == "09" ]; then
                        INSTALL_JUDGMENT="5:"
                    else
                        INSTALL_JUDGMENT=""
                    fi
                    ;;
                *)
                    INSTALL_JUDGMENT="5:"
                    ;;
                esac
                apt-get install -y docker-ce=${INSTALL_JUDGMENT}${DOCKER_VERSION}* docker-ce-cli=5:${DOCKER_VERSION}* containerd.io
                ;;
            "${SYSTEM_REDHAT}" | "${SYSTEM_OPENEULER}")
                yum install -y docker-ce-${DOCKER_VERSION} docker-ce-cli-${DOCKER_VERSION} containerd.io
                ;;
            esac
        fi
    }

    ## ä¿®æ”¹ Docker Hub æº
    function ConfigureMirror() {
        if [[ ${REGISTRY_SOURCE_OFFICIAL} == "False" ]]; then
            if [ -d $DockerDir ] && [ -e $DockerConfig ]; then
                if [ -e $DockerConfigBackup ]; then
                    local CHOICE_BACKUP=$(echo -e "\n${BOLD}â””â”€ æ£€æµ‹åˆ°å·²å¤‡ä»½çš„ Docker é…ç½®æ–‡ä»¶ï¼Œæ˜¯å¦è·³è¿‡è¦†ç›–å¤‡ä»½? [Y/n] ${PLAIN}")
                    read -p "${CHOICE_BACKUP}" INPUT
                    [ -z ${INPUT} ] && INPUT=Y
                    case $INPUT in
                    [Yy] | [Yy][Ee][Ss]) ;;
                    [Nn] | [Nn][Oo])
                        echo ''
                        cp -rvf $DockerConfig $DockerConfigBackup 2>&1
                        ;;
                    *)
                        echo -e "\n$WARN è¾“å…¥é”™è¯¯ï¼Œé»˜è®¤ä¸è¦†ç›–ï¼"
                        ;;
                    esac
                else
                    cp -rvf $DockerConfig $DockerConfigBackup 2>&1
                    echo -e "\n$COMPLETE å·²å¤‡ä»½åŸæœ‰ Docker é…ç½®æ–‡ä»¶è‡³ $DockerConfigBackup\n"
                fi
                sleep 2s
            else
                mkdir -p $DockerDir >/dev/null 2>&1
                touch $DockerConfig
            fi
            echo -e '{\n  "registry-mirrors": ["https://SOURCE"]\n}' >$DockerConfig
            sed -i "s/SOURCE/$REGISTRY_SOURCE/g" $DockerConfig
            systemctl daemon-reload
        fi
    }

    ## åˆ¤å®šæ˜¯å¦å·²å®‰è£…
    case "${SYSTEM_FACTIONS}" in
    "${SYSTEM_DEBIAN}")
        dpkg -l | grep docker-ce-cli -q
        ;;
    "${SYSTEM_REDHAT}" | "${SYSTEM_OPENEULER}")
        rpm -qa | grep docker-ce-cli -q
        ;;
    esac
    if [ $? -eq 0 ]; then
        Export_VersionList
        DOCKER_INSTALLED_VERSION=$(docker -v | grep -Eo "[0-9][0-9].[0-9]{1,2}.[0-9]{1,2}")
        DOCKER_VERSION_LATEST=$(cat $DockerVersionFile | head -n 1)
        if [[ ${DOCKER_INSTALLED_VERSION} == ${DOCKER_VERSION_LATEST} ]]; then
            if [[ ${DOCKER_VERSION_INSTALL_LATEST} == "True" ]]; then
                echo -e "\n$COMPLETE æ£€æµ‹åˆ°å·²å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Docker Engineï¼Œè·³è¿‡å®‰è£…"
                ConfigureMirror
                if [[ $(systemctl is-active docker) == "active" ]]; then
                    systemctl restart docker
                fi
                echo ''
                systemctl enable --now docker >/dev/null 2>&1
                ShowVersion
                AuthorSignature
                exit
            else
                local CHOICE=$(echo -e "\n${BOLD}â””â”€ æ£€æµ‹åˆ°å·²å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Docker Engineï¼Œæ˜¯å¦ç»§ç»­å®‰è£…å…¶å®ƒç‰ˆæœ¬? [Y/n] ${PLAIN}")
            fi
        else
            if [[ ${DOCKER_VERSION_INSTALL_LATEST} == "True" ]]; then
                local CHOICE=$(echo -e "\n${BOLD}â””â”€ æ£€æµ‹åˆ°å·²å®‰è£…æ—§ç‰ˆæœ¬çš„ Docker Engineï¼Œæ˜¯å¦è¦†ç›–å®‰è£…ä¸ºæœ€æ–°ç‰ˆæœ¬? [Y/n] ${PLAIN}")
            else
                local CHOICE=$(echo -e "\n${BOLD}â””â”€ æ£€æµ‹åˆ°å·²å®‰è£…æ—§ç‰ˆæœ¬çš„ Docker Engineï¼Œæ˜¯å¦ç»§ç»­å®‰è£…å…¶å®ƒç‰ˆæœ¬? [Y/n] ${PLAIN}")
            fi
        fi
        read -p "${CHOICE}" INPUT
        [ -z ${INPUT} ] && INPUT=Y
        case $INPUT in
        [Yy] | [Yy][Ee][Ss])
            echo -en "\n$WORKING æ­£åœ¨å¸è½½ä¹‹å‰çš„ç‰ˆæœ¬..."
            RemoveOldVersion
            echo -e "\n\n$COMPLETE å¸è½½å®Œæ¯•\n"
            Install
            ;;
        [Nn] | [Nn][Oo]) ;;
        *)
            echo -e "\n$WARN è¾“å…¥é”™è¯¯ï¼Œé»˜è®¤ä¸è¦†ç›–å®‰è£…ï¼\n"
            ;;
        esac
        rm -rf $DockerVersionFile
    else
        RemoveOldVersion
        Install
    fi
    ConfigureMirror
    systemctl stop docker >/dev/null 2>&1
    systemctl enable --now docker >/dev/null 2>&1
}

## æŸ¥çœ‹ç‰ˆæœ¬å¹¶éªŒè¯å®‰è£…ç»“æœ
function ShowVersion() {
    echo -e "\n$WORKING éªŒè¯å®‰è£…ç‰ˆæœ¬...\n"
    docker -v
    VERIFICATION_DOCKER=$?
    if [ ${VERIFICATION_DOCKER} -eq 0 ]; then
        echo -e "\n$COMPLETE å®‰è£…å®Œæˆ"
    else
        echo -e "\n$ERROR å®‰è£…å¤±è´¥"
        case "${SYSTEM_FACTIONS}" in
        "${SYSTEM_DEBIAN}")
            echo -e "\næ£€æŸ¥æºæ–‡ä»¶ï¼šcat $Dir_DebianExtendSource/docker.list"
            echo -e 'è¯·å°è¯•æ‰‹åŠ¨æ‰§è¡Œå®‰è£…å‘½ä»¤ï¼š apt-get install -y docker-ce docker-ce-cli containerd.io\n'
            echo ''
            ;;
        "${SYSTEM_REDHAT}" | "${SYSTEM_OPENEULER}")
            echo -e "\næ£€æŸ¥æºæ–‡ä»¶ï¼šcat $Dir_RedHatRepos/docker.repo"
            echo -e 'è¯·å°è¯•æ‰‹åŠ¨æ‰§è¡Œå®‰è£…å‘½ä»¤ï¼š yum install -y docker-ce docker-ce-cli containerd.io\n'
            ;;
        esac
        exit
    fi
    if [[ $(systemctl is-active docker) != "active" ]]; then
        sleep 2
        systemctl disable --now docker >/dev/null 2>&1
        sleep 2
        systemctl enable --now docker >/dev/null 2>&1
        sleep 2
        if [[ $(systemctl is-active docker) != "active" ]]; then
            echo -e "\n$ERROR æ£€æµ‹åˆ° Docker æœåŠ¡å¯åŠ¨å¼‚å¸¸ï¼Œå¯èƒ½ç”±äºé‡å¤å®‰è£…ç›¸åŒç‰ˆæœ¬å¯¼è‡´"
            echo -e "\nè¯·æ‰§è¡Œ systemctl start docker æˆ– service docker start å‘½ä»¤å°è¯•å¯åŠ¨"
            echo -e "\nå®˜æ–¹å®‰è£…æ–‡æ¡£ï¼šhttps://docs.docker.com/engine/install"
        fi
    fi
}

function ChooseMirrors() {

    function WelcomeTitle() {
        local system_name="${SYSTEM_PRETTY_NAME:-"${SYSTEM_NAME} ${SYSTEM_VERSION_NUMBER}"}"
        local arch="${SYSTEM_ARCH}"
        local date="$(date "+%Y-%m-%d %H:%M:%S")"
        local timezone="$(timedatectl status 2>/dev/null | grep "Time zone" | awk -F ':' '{print$2}' | awk -F ' ' '{print$1}')"

        echo -e '+------------------------------------+'
        echo -e '|                                    |'
        echo -e '|    æ¬¢è¿ä½¿ç”¨ Docker ä¸€é”®å®‰è£…è„šæœ¬    |'
        echo -e '|                                    |'
        echo -e '+------------------------------------+'
        echo -e ''
        echo -e " è¿è¡Œç¯å¢ƒ  ${BLUE}${system_name} ${arch}${PLAIN}"
        echo -e " ç³»ç»Ÿæ—¶é—´  ${BLUE}${date} ${timezone}${PLAIN}"
        echo -e ''
    }
    clear
    WelcomeTitle

    ## æ˜¯å¦æ‰‹åŠ¨é€‰æ‹©å®‰è£…ç‰ˆæœ¬
    local CHOICE_A=$(echo -e "${BOLD}â””â”€ æ˜¯å¦å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Docker Engine? [Y/n] ${PLAIN}")
    read -p "${CHOICE_A}" INPUT
    [ -z ${INPUT} ] && INPUT=Y
    case $INPUT in
    [Yy] | [Yy][Ee][Ss])
        DOCKER_VERSION_INSTALL_LATEST="True"
        ;;
    [Nn] | [Nn][Oo])
        DOCKER_VERSION_INSTALL_LATEST="False"
        SOURCE="download.docker.com"
        ;;
    *)
        DOCKER_VERSION_INSTALL_LATEST="True"
        echo -e "\n$WARN è¾“å…¥é”™è¯¯ï¼Œé»˜è®¤å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼"
        ;;
    esac
    if [ -z $SOURCE ]; then
        echo -e ''
        echo -e ' â–   é˜¿é‡Œäº‘           1)'
        echo -e ' â–   è…¾è®¯äº‘           2)'
        echo -e ' â–   åä¸ºäº‘           3)'
        echo -e ' â–   Azure            4)'
        echo -e ' â–   ç½‘æ˜“             5)'
        echo -e ' â–   æ¸…åå¤§å­¦         6)'
        echo -e ' â–   å—äº¬å¤§å­¦         7)'
        echo -e ' â–   ä¸­ç§‘å¤§           8)'
        echo -e ' â–   ä¸­ç§‘é™¢           9)'
        echo -e ' â–   å®˜æ–¹            10)'
        local CHOICE_B=$(echo -e "\n${BOLD}â””â”€ è¯·é€‰æ‹©å¹¶è¾“å…¥ä½ æƒ³ä½¿ç”¨çš„ Docker CE æº [ 1~10 ]ï¼š${PLAIN}")
        read -p "${CHOICE_B}" INPUT
        case $INPUT in
        1)
            SOURCE="mirrors.aliyun.com/docker-ce"
            ;;
        2)
            SOURCE="mirrors.tencent.com/docker-ce"
            ;;
        3)
            SOURCE="repo.huaweicloud.com/docker-ce"
            ;;
        4)
            SOURCE="mirror.azure.cn/docker-ce"
            ;;
        5)
            SOURCE="mirrors.163.com/docker-ce"
            ;;
        6)
            SOURCE="mirrors.tuna.tsinghua.edu.cn/docker-ce"
            ;;
        6)
            SOURCE="mirrors.nju.edu.cn/docker-ce"
            ;;
        8)
            SOURCE="mirrors.ustc.edu.cn/docker-ce"
            ;;
        9)
            SOURCE="mirror.iscas.ac.cn/docker-ce"
            ;;
        10)
            SOURCE="download.docker.com"
            ;;
        *)
            SOURCE="mirrors.aliyun.com/docker-ce"
            echo -e "\n$WARN è¾“å…¥é”™è¯¯ï¼Œé»˜è®¤ä½¿ç”¨é˜¿é‡Œäº‘ï¼"
            sleep 1s
            ;;
        esac
    fi
    echo -e ''
    echo -e ' â–   é˜¿é‡Œäº‘ï¼ˆåŒ—äº¬ï¼‰   1)'
    echo -e ' â–   é˜¿é‡Œäº‘ï¼ˆæ­å·ï¼‰   2)'
    echo -e ' â–   é˜¿é‡Œäº‘ï¼ˆæˆéƒ½ï¼‰   3)'
    echo -e ' â–   é˜¿é‡Œäº‘ï¼ˆå¹¿å·ï¼‰   4)'
    echo -e ' â–   é˜¿é‡Œäº‘ï¼ˆé¦™æ¸¯ï¼‰   5)'
    echo -e ' â–   è…¾è®¯äº‘           6)'
    echo -e ' â–   Azure            7)'
    echo -e ' â–   DaoCloud         8)'
    echo -e ' â–   ä¸­ç§‘å¤§           9)'
    echo -e ' â–   è°·æ­Œäº‘          10)'
    echo -e ' â–   å®˜æ–¹            11)'
    local CHOICE_C=$(echo -e "\n${BOLD}â””â”€ è¯·é€‰æ‹©å¹¶è¾“å…¥ä½ æƒ³ä½¿ç”¨çš„ Docker Hub æº [ 1~11 ]ï¼š${PLAIN}")
    read -p "${CHOICE_C}" INPUT
    case $INPUT in
    1)
        REGISTRY_SOURCE="registry.cn-beijing.aliyuncs.com"
        REGISTRY_SOURCE_OFFICIAL="False"
        ;;
    2)
        REGISTRY_SOURCE="registry.cn-hangzhou.aliyuncs.com"
        REGISTRY_SOURCE_OFFICIAL="False"
        ;;
    3)
        REGISTRY_SOURCE="registry.cn-chengdu.aliyuncs.com"
        REGISTRY_SOURCE_OFFICIAL="False"
        ;;
    4)
        REGISTRY_SOURCE="registry.cn-guangzhou.aliyuncs.com"
        REGISTRY_SOURCE_OFFICIAL="False"
        ;;
    5)
        REGISTRY_SOURCE="registry.cn-hongkong.aliyuncs.com"
        REGISTRY_SOURCE_OFFICIAL="False"
        ;;
    6)
        REGISTRY_SOURCE="mirror.ccs.tencentyun.com"
        REGISTRY_SOURCE_OFFICIAL="False"
        ;;
    7)
        REGISTRY_SOURCE="dockerhub.azk8s.com"
        REGISTRY_SOURCE_OFFICIAL="False"
        ;;
    8)
        REGISTRY_SOURCE="f1361db2.m.daocloud.io"
        REGISTRY_SOURCE_OFFICIAL="False"
        ;;
    9)
        REGISTRY_SOURCE="docker.mirrors.ustc.edu.cn"
        REGISTRY_SOURCE_OFFICIAL="False"
        ;;
    10)
        REGISTRY_SOURCE="gcr.io"
        REGISTRY_SOURCE_OFFICIAL="False"
        ;;
    11)
        REGISTRY_SOURCE="registry.docker-cn.com"
        REGISTRY_SOURCE_OFFICIAL="True"
        ;;
    *)
        REGISTRY_SOURCE="registry.cn-hangzhou.aliyuncs.com"
        REGISTRY_SOURCE_OFFICIAL="False"
        echo -e "\n$WARN è¾“å…¥é”™è¯¯ï¼Œé»˜è®¤ä½¿ç”¨ ${BLUE}é˜¿é‡Œäº‘ï¼ˆæ­å·ï¼‰${PLAIN}ï¼"
        sleep 1s
        ;;
    esac
    echo -e ''

    CloseFirewall
}

## ç»„åˆå‡½æ•°
function Combin_Function() {
    PermissionJudgment
    EnvJudgment
    ChooseMirrors
    InstallationEnvironment
    ConfigureDockerCEMirror
    DockerEngine
    ShowVersion
    AuthorSignature
}

Combin_Function
